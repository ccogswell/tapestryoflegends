{% extends "base.html" %}

{% block title %}Bulk Manage Aliases{% endblock %}

{% block content %}
<style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .main-container {
            padding: 20px 0;
        }
        
        .table-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .table th {
            background: #f8f9fa;
            border: none;
            font-weight: 600;
            color: #495057;
            white-space: nowrap;
        }
        
        .table td {
            border: none;
            vertical-align: middle;
            padding: 12px 8px;
        }
        
        .table tbody tr:hover {
            background-color: #f8f9fa;
        }
        
        .editable {
            cursor: pointer;
            position: relative;
            min-height: 20px;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.2s;
        }
        
        .editable:hover {
            background-color: #e9ecef;
        }
        
        .editing {
            background-color: #fff3cd;
        }
        
        .tag-badge {
            display: inline-block;
            background: #007bff;
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.75em;
            margin: 1px;
        }
        
        .bulk-actions {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .avatar-thumb {
            width: 40px;
            height: 40px;
            object-fit: cover;
            border-radius: 50%;
        }
        
        .pagination-controls {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        

        
        .import-preview {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .drop-zone {
            border: 2px dashed #6c757d;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            background: #f8f9fa;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .drop-zone:hover, .drop-zone.dragover {
            border-color: #007bff;
            background: #e3f2fd;
            color: #007bff;
        }
    </style>

<div class="container-fluid main-container">
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h2 class="text-white mb-0">
                            <i class="fas fa-table"></i> Bulk Manage Aliases
                            <span class="badge bg-primary ms-2" id="total-count">{{ aliases_count }}</span>
                        </h2>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-success" onclick="exportCSV()">
                            <i class="fas fa-download"></i> Export CSV
                        </button>
                        <button class="btn btn-info" onclick="showImportModal()">
                            <i class="fas fa-upload"></i> Import CSV
                        </button>
                    </div>
                </div>

                <!-- Bulk Actions -->
                <div class="bulk-actions">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <div class="d-flex align-items-center gap-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="select-all" onchange="toggleSelectAll()">
                                    <label class="form-check-label" for="select-all">Select All</label>
                                </div>
                                <span id="selected-count" class="text-muted">0 selected</span>
                            </div>
                        </div>
                        <div class="col-md-6 text-end">
                            <div class="btn-group">
                                <button class="btn btn-outline-primary btn-sm" onclick="bulkEdit()" id="bulk-edit-btn" disabled>
                                    <i class="fas fa-edit"></i> Edit Selected
                                </button>
                                <button class="btn btn-outline-secondary btn-sm" onclick="bulkDuplicate()" id="bulk-duplicate-btn" disabled>
                                    <i class="fas fa-copy"></i> Duplicate
                                </button>
                                <button class="btn btn-outline-danger btn-sm" onclick="bulkDelete()" id="bulk-delete-btn" disabled>
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Search and Filter -->
                    <div class="row mt-3">
                        <div class="col-md-4">
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-search"></i></span>
                                <input type="text" class="form-control" id="search-input" placeholder="Search aliases..." onkeyup="searchTable()">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="group-filter" onchange="filterTable()">
                                <option value="">All Groups</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="page-size" onchange="changePageSize()">
                                <option value="25">25 per page</option>
                                <option value="50">50 per page</option>
                                <option value="100">100 per page</option>
                                <option value="all">Show All</option>
                            </select>
                        </div>
                        <div class="col-md-2 text-end">
                            <button class="btn btn-outline-secondary" onclick="resetFilters()">
                                <i class="fas fa-undo"></i> Reset
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Aliases Table -->
                <div class="table-container">
                    <table class="table table-hover mb-0" id="aliases-table">
                        <thead>
                            <tr>
                                <th width="30"><input type="checkbox" id="header-checkbox" onchange="toggleSelectAll()"></th>
                                <th width="60">Avatar</th>
                                <th>Name</th>
                                <th>Trigger</th>
                                <th>Race</th>
                                <th>Class</th>
                                <th>Group</th>
                                <th>Subgroup</th>
                                <th>Tags</th>
                                <th>Usage</th>
                                <th>Last Used</th>
                                <th width="80">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="aliases-tbody">
                            <!-- Table rows will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                <div class="pagination-controls">
                    <div class="d-flex justify-content-between align-items-center">
                        <div id="showing-info">Showing 0 of 0 aliases</div>
                        <nav>
                            <ul class="pagination pagination-sm mb-0" id="pagination">
                                <!-- Pagination buttons will be added by JavaScript -->
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Import CSV Modal -->
    <div class="modal fade" id="importModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Import Aliases from CSV</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="drop-zone" id="csv-drop-zone" onclick="document.getElementById('csv-file').click()">
                        <i class="fas fa-cloud-upload-alt fa-3x mb-3 text-muted"></i>
                        <h5>Drop CSV file here or click to browse</h5>
                        <p class="text-muted">
                            Expected columns: character_name, trigger_text, character_class, character_race, 
                            group_name, subgroup, tags, character_description, personality, backstory
                        </p>
                        <input type="file" id="csv-file" accept=".csv" style="display: none;" onchange="handleCSVUpload(this)">
                    </div>
                    
                    <div id="import-preview" class="import-preview" style="display: none;">
                        <h6>Preview (first 10 rows):</h6>
                        <div class="table-responsive">
                            <table class="table table-sm table-striped" id="preview-table">
                                <thead id="preview-thead"></thead>
                                <tbody id="preview-tbody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirm-import-btn" onclick="confirmImport()" disabled>
                        Import Aliases
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bulk Edit Modal -->
    <div class="modal fade" id="bulkEditModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Bulk Edit Selected Aliases</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted mb-3">Changes will be applied to all selected aliases. Leave fields empty to keep existing values.</p>
                    <form id="bulk-edit-form">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Group</label>
                                    <input type="text" class="form-control" id="bulk-group">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Subgroup</label>
                                    <input type="text" class="form-control" id="bulk-subgroup">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Race</label>
                                    <input type="text" class="form-control" id="bulk-race">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Class</label>
                                    <input type="text" class="form-control" id="bulk-class">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Tags</label>
                                    <input type="text" class="form-control" id="bulk-tags" placeholder="Separate with commas">
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="applyBulkEdit()">Apply Changes</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables
        let allAliases = {{ aliases_json|safe }};
        let filteredAliases = [...allAliases];
        let selectedAliases = new Set();
        let currentPage = 1;
        let pageSize = 25;

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            populateGroupFilter();
            renderTable();
            setupEventListeners();
        });

        function populateGroupFilter() {
            const groups = new Set();
            allAliases.forEach(alias => {
                if (alias.group_name) groups.add(alias.group_name);
            });
            
            const groupFilter = document.getElementById('group-filter');
            groups.forEach(group => {
                const option = document.createElement('option');
                option.value = group;
                option.textContent = group;
                groupFilter.appendChild(option);
            });
        }

        function renderTable() {
            const tbody = document.getElementById('aliases-tbody');
            tbody.innerHTML = '';
            
            const start = pageSize === 'all' ? 0 : (currentPage - 1) * parseInt(pageSize);
            const end = pageSize === 'all' ? filteredAliases.length : start + parseInt(pageSize);
            const pageAliases = filteredAliases.slice(start, end);
            
            pageAliases.forEach(alias => {
                const row = createTableRow(alias);
                tbody.appendChild(row);
            });
            
            updatePagination();
            updateShowingInfo();
            updateSelectedCount();
        }

        function createTableRow(alias) {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>
                    <input type="checkbox" class="alias-checkbox" value="${alias.id}" 
                           ${selectedAliases.has(alias.id) ? 'checked' : ''} 
                           onchange="toggleAliasSelection(${alias.id})">
                </td>
                <td>
                    <img src="${alias.avatar_url || '/static/default-avatar.png'}" 
                         class="avatar-thumb" alt="Avatar">
                </td>
                <td class="editable" data-field="character_name" data-id="${alias.id}">${alias.character_name || ''}</td>
                <td class="editable" data-field="trigger_text" data-id="${alias.id}">${alias.trigger_text || ''}</td>
                <td class="editable" data-field="character_race" data-id="${alias.id}">${alias.character_race || ''}</td>
                <td class="editable" data-field="character_class" data-id="${alias.id}">${alias.character_class || ''}</td>
                <td class="editable" data-field="group_name" data-id="${alias.id}">${alias.group_name || ''}</td>
                <td class="editable" data-field="subgroup" data-id="${alias.id}">${alias.subgroup || ''}</td>
                <td class="editable" data-field="tags_raw" data-id="${alias.id}">
                    <div class="tags-display">
                        ${(alias.tags || []).map(tag => `<span class="tag-badge">${tag}</span>`).join('')}
                        <span class="tags-text" style="display: none;">${alias.tags_raw || ''}</span>
                    </div>
                </td>
                <td>${alias.message_count || 0}</td>
                <td>${alias.last_used || 'Never'}</td>
                <td>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteAlias(${alias.id})" title="Delete">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;
            return row;
        }

        function setupEventListeners() {
            // Make cells editable
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('editable')) {
                    makeEditable(e.target);
                }
            });
            
            // CSV drag and drop
            const dropZone = document.querySelector('.drop-zone');
            dropZone.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.classList.add('dragover');
            });
            
            dropZone.addEventListener('dragleave', function() {
                this.classList.remove('dragover');
            });
            
            dropZone.addEventListener('drop', function(e) {
                e.preventDefault();
                this.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0 && files[0].name.endsWith('.csv')) {
                    handleCSVUpload({ files: files });
                }
            });
        }

        function makeEditable(cell) {
            if (cell.querySelector('input')) return; // Already editing
            
            const field = cell.dataset.field;
            const aliasId = cell.dataset.id;
            let currentValue = '';
            
            if (field === 'tags_raw') {
                currentValue = cell.querySelector('.tags-text').textContent;
            } else {
                currentValue = cell.textContent.trim();
            }
            
            cell.classList.add('editing');
            cell.innerHTML = `<input type="text" class="form-control form-control-sm" value="${currentValue}" style="border: none; outline: none;">`;
            
            const input = cell.querySelector('input');
            input.focus();
            input.select();
            
            function saveEdit() {
                const newValue = input.value.trim();
                updateAliasField(aliasId, field, newValue);
                cell.classList.remove('editing');
                
                if (field === 'tags_raw') {
                    const tags = newValue.split(',').map(t => t.trim()).filter(t => t);
                    cell.innerHTML = `
                        <div class="tags-display">
                            ${tags.map(tag => `<span class="tag-badge">${tag}</span>`).join('')}
                            <span class="tags-text" style="display: none;">${newValue}</span>
                        </div>
                    `;
                } else {
                    cell.textContent = newValue;
                }
            }
            
            input.addEventListener('blur', saveEdit);
            input.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    saveEdit();
                }
                if (e.key === 'Escape') {
                    cell.classList.remove('editing');
                    if (field === 'tags_raw') {
                        const tags = currentValue.split(',').map(t => t.trim()).filter(t => t);
                        cell.innerHTML = `
                            <div class="tags-display">
                                ${tags.map(tag => `<span class="tag-badge">${tag}</span>`).join('')}
                                <span class="tags-text" style="display: none;">${currentValue}</span>
                            </div>
                        `;
                    } else {
                        cell.textContent = currentValue;
                    }
                }
            });
        }

        async function updateAliasField(aliasId, field, value) {
            try {
                const response = await fetch('/web/api/aliases/update', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        alias_id: aliasId,
                        [field]: value
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Failed to update alias');
                }
                
                // Update local data
                const alias = allAliases.find(a => a.id == aliasId);
                if (alias) {
                    alias[field] = value;
                    if (field === 'tags_raw') {
                        alias.tags = value.split(',').map(t => t.trim()).filter(t => t);
                    }
                }
                
            } catch (error) {
                console.error('Error updating alias:', error);
                alert('Failed to update alias. Please try again.');
            }
        }

        function toggleAliasSelection(aliasId) {
            if (selectedAliases.has(aliasId)) {
                selectedAliases.delete(aliasId);
            } else {
                selectedAliases.add(aliasId);
            }
            updateSelectedCount();
            updateBulkActionButtons();
        }

        function toggleSelectAll() {
            const selectAll = document.getElementById('select-all');
            const checkboxes = document.querySelectorAll('.alias-checkbox');
            
            if (selectAll.checked) {
                checkboxes.forEach(cb => {
                    cb.checked = true;
                    selectedAliases.add(parseInt(cb.value));
                });
            } else {
                checkboxes.forEach(cb => {
                    cb.checked = false;
                    selectedAliases.delete(parseInt(cb.value));
                });
            }
            
            updateSelectedCount();
            updateBulkActionButtons();
        }

        function updateSelectedCount() {
            document.getElementById('selected-count').textContent = `${selectedAliases.size} selected`;
        }

        function updateBulkActionButtons() {
            const hasSelected = selectedAliases.size > 0;
            document.getElementById('bulk-edit-btn').disabled = !hasSelected;
            document.getElementById('bulk-duplicate-btn').disabled = !hasSelected;
            document.getElementById('bulk-delete-btn').disabled = !hasSelected;
        }

        function searchTable() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const groupFilter = document.getElementById('group-filter').value;
            
            filteredAliases = allAliases.filter(alias => {
                const matchesSearch = !searchTerm || 
                    Object.values(alias).some(value => 
                        value && value.toString().toLowerCase().includes(searchTerm)
                    );
                
                const matchesGroup = !groupFilter || alias.group_name === groupFilter;
                
                return matchesSearch && matchesGroup;
            });
            
            currentPage = 1;
            renderTable();
        }

        function filterTable() {
            searchTable(); // Reuse search logic
        }

        function resetFilters() {
            document.getElementById('search-input').value = '';
            document.getElementById('group-filter').value = '';
            filteredAliases = [...allAliases];
            currentPage = 1;
            renderTable();
        }

        function changePageSize() {
            pageSize = document.getElementById('page-size').value;
            currentPage = 1;
            renderTable();
        }

        function updatePagination() {
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = '';
            
            if (pageSize === 'all') return;
            
            const totalPages = Math.ceil(filteredAliases.length / parseInt(pageSize));
            
            // Previous button
            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
            prevLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage - 1})">Previous</a>`;
            pagination.appendChild(prevLi);
            
            // Page numbers
            for (let i = 1; i <= totalPages; i++) {
                if (i === currentPage || i <= 2 || i >= totalPages - 1 || Math.abs(i - currentPage) <= 1) {
                    const li = document.createElement('li');
                    li.className = `page-item ${i === currentPage ? 'active' : ''}`;
                    li.innerHTML = `<a class="page-link" href="#" onclick="changePage(${i})">${i}</a>`;
                    pagination.appendChild(li);
                } else if (i === 3 && currentPage > 4) {
                    const li = document.createElement('li');
                    li.className = 'page-item disabled';
                    li.innerHTML = '<span class="page-link">...</span>';
                    pagination.appendChild(li);
                } else if (i === totalPages - 2 && currentPage < totalPages - 3) {
                    const li = document.createElement('li');
                    li.className = 'page-item disabled';
                    li.innerHTML = '<span class="page-link">...</span>';
                    pagination.appendChild(li);
                }
            }
            
            // Next button
            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
            nextLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage + 1})">Next</a>`;
            pagination.appendChild(nextLi);
        }

        function changePage(page) {
            const totalPages = Math.ceil(filteredAliases.length / parseInt(pageSize));
            if (page >= 1 && page <= totalPages) {
                currentPage = page;
                renderTable();
            }
        }

        function updateShowingInfo() {
            const start = pageSize === 'all' ? 1 : (currentPage - 1) * parseInt(pageSize) + 1;
            const end = pageSize === 'all' ? filteredAliases.length : Math.min(currentPage * parseInt(pageSize), filteredAliases.length);
            
            document.getElementById('showing-info').textContent = 
                `Showing ${start}-${end} of ${filteredAliases.length} aliases`;
        }

        // Export/Import functions
        function exportCSV() {
            const csvContent = convertToCSV(allAliases);
            downloadCSV(csvContent, 'aliases.csv');
        }

        function convertToCSV(data) {
            const headers = [
                'character_name', 'trigger_text', 'character_class', 'character_race',
                'character_description', 'personality', 'backstory', 'pronouns',
                'age', 'alignment', 'goals', 'notes', 'group_name', 'subgroup',
                'dndbeyond_url', 'tags', 'message_count', 'created_at', 'last_used'
            ];
            
            const csvRows = [headers.join(',')];
            
            data.forEach(alias => {
                const row = headers.map(header => {
                    let value = alias[header] || alias[header.replace('_raw', '')] || '';
                    if (header === 'tags') value = alias.tags_raw || '';
                    return `"${value.toString().replace(/"/g, '""')}"`;
                });
                csvRows.push(row.join(','));
            });
            
            return csvRows.join('\n');
        }

        function downloadCSV(content, filename) {
            const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function handleCSVUpload(input) {
            const file = input.files[0];
            if (!file || !file.name.endsWith('.csv')) {
                alert('Please select a valid CSV file.');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csv = e.target.result;
                    const aliases = parseCSV(csv);
                    if (aliases.length > 0) {
                        importData = aliases;
                        showImportPreview(aliases);
                        document.getElementById('confirm-import-btn').disabled = false;
                    }
                } catch (error) {
                    console.error('Error parsing CSV:', error);
                    alert('Error parsing CSV file. Please check the format.');
                }
            };
            reader.readAsText(file);
        }

        function showImportPreview(aliases) {
            const preview = document.getElementById('import-preview');
            const thead = document.getElementById('preview-thead');
            const tbody = document.getElementById('preview-tbody');
            
            if (aliases.length === 0) return;
            
            // Show headers
            const headers = Object.keys(aliases[0]);
            thead.innerHTML = '<tr>' + headers.map(h => `<th>${h}</th>`).join('') + '</tr>';
            
            // Show first 10 rows
            const previewData = aliases.slice(0, 10);
            tbody.innerHTML = previewData.map(alias => 
                '<tr>' + headers.map(h => `<td>${alias[h] || ''}</td>`).join('') + '</tr>'
            ).join('');
            
            preview.style.display = 'block';
        }

        function parseCSV(csv) {
            const lines = csv.split('\n').map(line => line.trim()).filter(line => line);
            if (lines.length < 2) return [];
            
            const headers = lines[0].split(',').map(h => h.replace(/"/g, '').trim());
            const aliases = [];
            
            for (let i = 1; i < lines.length; i++) {
                const values = parseCSVLine(lines[i]);
                if (values.length === headers.length) {
                    const alias = {};
                    headers.forEach((header, index) => {
                        alias[header] = values[index];
                    });
                    aliases.push(alias);
                }
            }
            
            return aliases;
        }

        function parseCSVLine(line) {
            const values = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    if (inQuotes && line[i + 1] === '"') {
                        current += '"';
                        i++; // Skip next quote
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    values.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            
            values.push(current.trim());
            return values;
        }



        // Bulk operations
        function bulkEdit() {
            if (selectedAliases.size === 0) return;
            new bootstrap.Modal(document.getElementById('bulkEditModal')).show();
        }

        async function applyBulkEdit() {
            const updates = {};
            const fields = ['group_name', 'subgroup', 'character_race', 'character_class', 'tags'];
            
            fields.forEach(field => {
                const input = document.getElementById(`bulk-${field.replace('character_', '').replace('_name', '')}`);
                if (input && input.value.trim()) {
                    updates[field] = input.value.trim();
                }
            });
            
            if (Object.keys(updates).length === 0) {
                alert('Please specify at least one field to update.');
                return;
            }
            
            try {
                const response = await fetch('/web/api/aliases/bulk-update', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        alias_ids: Array.from(selectedAliases),
                        updates: updates
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(`Successfully updated ${result.updated_count} aliases!`);
                    location.reload();
                } else {
                    alert(`Update failed: ${result.error}`);
                }
                
            } catch (error) {
                console.error('Error updating aliases:', error);
                alert('Failed to update aliases. Please try again.');
            }
            
            bootstrap.Modal.getInstance(document.getElementById('bulkEditModal')).hide();
        }

        async function bulkDuplicate() {
            if (selectedAliases.size === 0) return;
            
            if (!confirm(`Are you sure you want to duplicate ${selectedAliases.size} selected aliases?`)) {
                return;
            }
            
            try {
                const response = await fetch('/web/api/aliases/bulk-duplicate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        alias_ids: Array.from(selectedAliases)
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(`Successfully duplicated ${result.duplicated_count} aliases!`);
                    location.reload();
                } else {
                    alert(`Duplication failed: ${result.error}`);
                }
                
            } catch (error) {
                console.error('Error duplicating aliases:', error);
                alert('Failed to duplicate aliases. Please try again.');
            }
        }

        async function bulkDelete() {
            if (selectedAliases.size === 0) return;
            
            if (!confirm(`Are you sure you want to delete ${selectedAliases.size} selected aliases? This action cannot be undone.`)) {
                return;
            }
            
            try {
                const response = await fetch('/web/api/aliases/bulk-delete', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        alias_ids: Array.from(selectedAliases)
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(`Successfully deleted ${result.deleted_count} aliases!`);
                    location.reload();
                } else {
                    alert(`Deletion failed: ${result.error}`);
                }
                
            } catch (error) {
                console.error('Error deleting aliases:', error);
                alert('Failed to delete aliases. Please try again.');
            }
        }

        async function deleteAlias(aliasId) {
            if (!confirm('Are you sure you want to delete this alias? This action cannot be undone.')) {
                return;
            }
            
            try {
                const response = await fetch('/web/api/aliases/delete', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        alias_id: aliasId
                    })
                });
                
                if (response.ok) {
                    location.reload();
                } else {
                    alert('Failed to delete alias. Please try again.');
                }
                
            } catch (error) {
                console.error('Error deleting alias:', error);
                alert('Failed to delete alias. Please try again.');
            }
        }

        function showImportModal() {
            new bootstrap.Modal(document.getElementById('importModal')).show();
        }

        async function confirmImport() {
            if (!importData || importData.length === 0) {
                alert('No data to import.');
                return;
            }
            
            try {
                const response = await fetch('/web/api/aliases/bulk-import', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        aliases: importData
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(`Successfully imported ${result.imported_count} aliases!`);
                    location.reload();
                } else {
                    alert(`Import failed: ${result.error}`);
                }
                
            } catch (error) {
                console.error('Error importing aliases:', error);
                alert('Failed to import aliases. Please try again.');
            }
            
            bootstrap.Modal.getInstance(document.getElementById('importModal')).hide();
        }

        let importData = null;
    </script>
{% endblock %}